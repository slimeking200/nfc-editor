<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NFC Editor • PWA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1420">
  <style>
    :root { --bg:#0b0f14; --panel:#121827; --ink:#eaf0fb; --muted:#9fb0c8; --line:#1f293b; --ok:#7bffb5; --bad:#ff7a7a; --warn:#ffd36c; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{padding:14px 16px;border-bottom:1px solid var(--line);background:#0f1420;position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:18px}
    main{max-width:880px;margin:16px auto;padding:0 12px}
    section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
    textarea,input,select,button{width:100%;box-sizing:border-box;background:#0e1421;color:var(--ink);border:1px solid #2a3650;border-radius:10px;padding:10px;font-size:14px}
    button{cursor:pointer;background:#14223a}
    button.primary{background:linear-gradient(180deg,#214062,#193556);border-color:#2e4b72}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .muted{color:var(--muted)}
    pre{white-space:pre-wrap}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>
</head>
<body>
<header>
  <h1>NFC Editor • PWA</h1>
  <div id="support" class="pill" style="margin-top:8px"></div>
</header>

<main>
  <section>
    <h2>Install</h2>
    <div class="toolbar">
      <button id="btn-install" class="primary" disabled>Install App</button>
      <button id="btn-a2hs-help">How to Install (iOS/others)</button>
    </div>
    <p class="muted" id="install-hint">If the button is disabled, the browser hasn't fired <code>beforeinstallprompt</code> yet—interact for a moment, or use Chrome menu → Add to Home screen.</p>
  </section>

  <section>
    <h2>Write / Read NFC</h2>
    <div class="row">
      <div>
        <label>Paste JSON (.bin text works too)</label>
        <textarea id="payload" class="mono" rows="10" placeholder='{"t":"land","gid":"A1B2C3D4", ... }'></textarea>
      </div>
      <div>
        <label>Or choose a file (.bin / .json)</label>
        <input id="file" type="file" accept=".bin,.json,text/plain,application/json">
        <div style="margin-top:8px">
          <label>Record Type</label>
          <select id="rtype">
            <option value="mime">MIME (application/json)</option>
            <option value="text">Text (UTF-8)</option>
          </select>
        </div>
        <div style="margin-top:8px">
          <label class="muted">Optional MIME type (if not JSON):</label>
          <input id="mtype" value="application/json">
        </div>
      </div>
    </div>
    <div class="toolbar">
      <button id="btn-write" class="primary">Write to Tag</button>
      <button id="btn-read">Read Tag</button>
      <button id="btn-lock">Make Read-Only</button>
    </div>
    <p class="muted">Use Chrome on Android. Web NFC requires HTTPS or <code>http://localhost</code>.</p>
  </section>

  <section>
    <h2>Console</h2>
    <pre id="log" class="mono">(ready)</pre>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
const log = (m) => { const el=$("#log"); el.textContent = (el.textContent==="(ready)"?"":el.textContent+"\n")+m; };

// Service worker registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').then(
      () => log('SW registered'),
      err => log('SW registration failed: '+err)
    );
  });
}

// Install button via beforeinstallprompt
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $("#btn-install").disabled = false;
  log('beforeinstallprompt fired (install available)');
});

$("#btn-install").addEventListener('click', async () => {
  if (!deferredPrompt) { alert('Install not available yet'); return; }
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  log('Install choice: ' + choice.outcome);
  deferredPrompt = null;
  $("#btn-install").disabled = true;
});

$("#btn-a2hs-help").addEventListener('click', () => {
  alert('If install isn\'t offered automatically:\n• Android Chrome: use this Install button when it lights up, or Chrome menu → Add to Home Screen.\n• iOS Safari: Share → Add to Home Screen (no Web NFC).');
});

function setSupport(){
  if (!('NDEFReader' in window)) {
    $("#support").textContent = "Web NFC not available (Chrome on Android only)";
    $("#support").classList.add("warn");
  } else {
    const secure = window.isSecureContext;
    $("#support").textContent = secure ? "Web NFC ready (secure context)" : "Web NFC blocked (serve via HTTPS or localhost)";
    if (!secure) $("#support").classList.add("warn");
  }
}
setSupport();

$("#file").addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const text = await f.text();
  $("#payload").value = text.trim();
  log(`Loaded file: ${f.name} (${f.size} bytes)`);
});

async function writeTag(){
  if (!('NDEFReader' in window)) return alert("Web NFC not available in this browser.");
  if (!window.isSecureContext) return alert("Open over HTTPS or http://localhost for Web NFC.");
  const text = $("#payload").value.trim();
  if (!text) return alert("Paste JSON or load a file first.");
  const rtype = $("#rtype").value;
  const mtype = $("#mtype").value || "application/json";
  try {
    const ndef = new NDEFReader();
    if (rtype === "mime") {
      await ndef.write({ records: [{ recordType: "mime", mediaType: mtype, data: text }] });
    } else {
      await ndef.write(text);
    }
    log(`Write success (${rtype})`);
    alert("Write success");
  } catch (err) {
    console.error(err); log("Write failed: " + err); alert("Write failed: " + err);
  }
}

async function readTag(){
  if (!('NDEFReader' in window)) return alert("Web NFC not available in this browser.");
  if (!window.isSecureContext) return alert("Open over HTTPS or http://localhost for Web NFC.");
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    log("Scanning… tap a tag");
    ndef.onreading = event => {
      const { serialNumber, message } = event;
      log(`Tag serial: ${serialNumber || "(unknown)"}`);
      for (const rec of message.records) {
        const rt = rec.recordType, mt = rec.mediaType || "", enc = rec.encoding || "utf-8";
        let data = "(binary)";
        try { data = rec.data ? new TextDecoder(enc).decode(rec.data) : "(no data)"; } catch {}
        log(`Record: type=${rt} media=${mt}
Payload:
${data}`);
      }
    };
    ndef.onreadingerror = () => log("Read error.");
  } catch (err) {
    console.error(err); log("Scan failed: " + err); alert("Scan failed: " + err);
  }
}

async function lockTag(){
  if (!('NDEFReader' in window)) return alert("Web NFC not available in this browser.");
  if (!window.isSecureContext) return alert("Open over HTTPS or http://localhost for Web NFC.");
  if (!confirm("This will make the tag permanently read-only. Continue?")) return;
  try {
    const ndef = new NDEFReader();
    await ndef.makeReadOnly(); // experimental
    log("Tag locked (read-only)."); alert("Tag locked (read-only).");
  } catch (err) {
    console.error(err); log("Lock failed: " + err); alert("Lock failed: " + err);
  }
}

$("#btn-write").addEventListener("click", writeTag);
$("#btn-read").addEventListener("click", readTag);
$("#btn-lock").addEventListener("click", lockTag);
</script>
</body>
</html>
