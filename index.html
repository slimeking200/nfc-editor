<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fossil Diggers â€” Base Game (Shop)</title>
<style>
  :root { --bg:#0b0f14; --panel:#121827; --ink:#eaf0fb; --muted:#9fb0c8; --line:#23324a; --accent:#7bffb5; --bad:#ff7a7a; --gold:#ffd36c; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--line);background:#0f1420;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:18px}
  main{max-width:980px;margin:16px auto;padding:0 12px;display:grid;gap:12px;grid-template-columns: 1.1fr 1fr}
  section{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  h2{margin:0 0 8px 0;font-size:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  button{background:#13233a;color:var(--ink);border:1px solid #2a3a56;border-radius:10px;padding:10px 12px;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#234a6a,#183955);border-color:#2e557f}
  button:disabled{opacity:.6;cursor:not-allowed}
  input,select,textarea{background:#0e1624;color:var(--ink);border:1px solid #2a3a56;border-radius:10px;padding:8px}
  .money{font-weight:700;color:var(--accent)}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .list{display:flex;flex-direction:column;gap:8px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0f1828}
  .rightcol{display:flex;flex-direction:column;gap:12px}
  .found{color:var(--accent)}
  .warn{color:var(--gold)}
  .bad{color:var(--bad)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .small{font-size:12px}
  details summary{cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Fossil Diggers â€” Base Game</h1>
  <div id="support" class="pill" style="margin-top:6px"></div>
</header>

<div id="permitModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50">
  <div style="background:#0f1828;border:1px solid #23324a;border-radius:14px;max-width:520px;width:92%;padding:14px">
    <h3 style="margin:0 0 8px 0;font-size:18px">Permit Required</h3>
    <div class="small muted" id="permitText">You need a permit to excavate here.</div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="permitCancel">Cancel</button>
      <button id="permitBuy" class="primary">Buy Permit</button>
    </div>
  </div>
</div>


<main>
  <!-- Left: Play panel -->
  <section>
    <h2>Play</h2>
    <div class="row" style="margin-bottom:8px">
      <button id="btn-scan" class="primary">Scan NFC Tag</button>
      <span id="site-pill" class="pill">Current site: <span id="curSite">None</span></span>
      <span id="game-pill" class="pill">Game ID: <span id="curGame">â€”</span></span>
    </div>

    <details>
      <summary class="muted">No NFC? Paste site or control-tag JSON manually</summary>
      <textarea id="manualJson" class="mono" rows="6" placeholder='Paste JSON here (site/game_seed/game_join/game_results)'></textarea>
      <div class="row" style="margin-top:6px">
        <button id="btn-load-json">Load JSON</button>
        <span class="small muted">Emulates an NFC scan using pasted data.</span>
      </div>
    </details>

    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0" />

    <div class="grid2">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted small">Money</div>
            <div class="money" id="money">$0</div>
          </div>
          <div>
            <div class="muted small">Museum income (per min)</div>
            <div id="perMin">$0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:baseline">
          <h3 style="margin:0;font-size:15px">Shop</h3>
          <div class="small muted">Each tier doubles in price; Tier 1 = $500. Each tier = +10% effect.</div>
        </div>
        <div class="list small" id="shopList"></div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label class="small muted">Time to spend digging (hours)</label>
          <input type="range" id="digHours" min="0.5" max="8" value="2" step="0.5" />
          <div class="row small">
            <span>Hours: <b id="hoursLabel">2.0</b></span>
            <span class="muted">More hours â†’ more chances to find something.</span>
          </div>
        </div>
        <div>
          <button id="btn-dig" class="primary">Dig at current site</button>
        </div>
      </div>
      <div id="siteSummary" class="small muted" style="margin-top:8px"></div>
    </div>

    <div id="digResults" class="list"></div>
  </section>

  <!-- Right: Inventory & Museum -->
  <div class="rightcol">
    <section>
      <h2>Inventory</h2>
      <div id="invList" class="list"></div>
    </section>

    <section>
      <h2>Museum</h2>
      <div class="small muted">Items on display generate money each minute.</div>
      <div id="museumList" class="list" style="margin-top:8px"></div>
    </section>
  </div>
</main>

<script>
// -----------------------------
// State & persistence
// -----------------------------
const state = {
  money: 1000,
  inventory: [],
  museum: [],
  currentSite: null,
  lastIncomeTick: Date.now(),
  game: {
    gameId: null,
    rules: null,
    playerId: null,
    deviceHash: null
  },
  tools: { brushes: 0, jackhammers: 0, shovels: 0 },
  permits: {},
  permitPriceBase: 1000
};

const PRICE_TABLE = {
  "Tyrannosaurus rex": 12000,
  "Triceratops": 5000,
  "Torosaurus": 4500,
  "Edmontosaurus": 2500,
  "Dakotaraptor": 7000,
  "Thescelosaurus": 1800,
  "Anzu": 4000,
  "Allosaurus": 5000,
  "Ceratosaurus": 4200,
  "Torvosaurus": 4800,
  "Stegosaurus": 3500,
  "Camptosaurus": 2000,
  "Dryosaurus": 1500,
  "Apatosaurus": 6000,
  "Diplodocus": 6000,
  "Camarasaurus": 5500,
  "Brachiosaurus": 9000,
  "Gorgosaurus": 5200,
  "Centrosaurus": 2400,
  "Chasmosaurus": 2600,
  "Corythosaurus": 2200,
  "Lambeosaurus": 2300,
  "Styracosaurus": 2800,
  "Microraptor": 2700,
  "Sinosauropteryx": 2300,
  "Confuciusornis": 1600,
  "Psittacosaurus": 1400,
  "Yutyrannus": 8000,
  "Archaeopteryx": 12000,
  "Rhamphorhynchus (pterosaur)": 3000,
  "Sauropod bones": 1200,
  "Sauropod teeth": 700,
  "Small theropod teeth": 900,
  "FossilizedEggshell": 600,
  "Turtles": 800,
  "Crocodyliform remains": 1100,
  "Gar fish scales": 300,
  "Fish scales": 250,
  "Ganoid fish scales": 350,
  "Insect impressions": 300,
  "Plant impressions": 300,
  "Crustaceans": 400,
  "Cephalopod remains": 500,
  "Echinoderms": 350,
  "FossilFragments": 200,
  "NothingFound": 0
};

const MUSEUM_YIELD = { // per minute
  "Tyrannosaurus rex": 90,
  "Triceratops": 35,
  "Torosaurus": 32,
  "Edmontosaurus": 18,
  "Dakotaraptor": 50,
  "Thescelosaurus": 12,
  "Anzu": 28,
  "Allosaurus": 35,
  "Ceratosaurus": 31,
  "Torvosaurus": 34,
  "Stegosaurus": 24,
  "Camptosaurus": 13,
  "Dryosaurus": 10,
  "Apatosaurus": 45,
  "Diplodocus": 45,
  "Camarasaurus": 42,
  "Brachiosaurus": 70,
  "Gorgosaurus": 36,
  "Centrosaurus": 17,
  "Chasmosaurus": 18,
  "Corythosaurus": 15,
  "Lambeosaurus": 16,
  "Styracosaurus": 19,
  "Microraptor": 19,
  "Sinosauropteryx": 16,
  "Confuciusornis": 11,
  "Psittacosaurus": 10,
  "Yutyrannus": 60,
  "Archaeopteryx": 90,
  "Rhamphorhynchus (pterosaur)": 20,
  "Sauropod bones": 7,
  "Sauropod teeth": 4,
  "Small theropod teeth": 6,
  "FossilizedEggshell": 5,
  "Turtles": 7,
  "Crocodyliform remains": 9,
  "Gar fish scales": 2,
  "Fish scales": 2,
  "Ganoid fish scales": 3,
  "Insect impressions": 3,
  "Plant impressions": 3,
  "Crustaceans": 4,
  "Cephalopod remains": 5,
  "Echinoderms": 3,
  "FossilFragments": 1
};

const uid = () => Math.random().toString(36).slice(2, 9);

function save() {
  localStorage.setItem("fdg_state", JSON.stringify(state));
}

function load() {
  const s = localStorage.getItem("fdg_state");
  if (s) {
    try { const old = JSON.parse(s); Object.assign(state, old); } catch {}
  }
  function stableId(key, len=8){
    const s = localStorage.getItem(key);
    if (s) return s;
    const v = Math.random().toString(36).slice(2,2+len);
    localStorage.setItem(key, v);
    return v;
  }
  state.game.playerId = state.game.playerId || stableId("fdg_player_id", 8);
  state.game.deviceHash = state.game.deviceHash || stableId("fdg_device_hash", 16);

  // Backfill tools if missing
  state.tools = state.tools || { brushes: 0, jackhammers: 0, shovels: 0 };
}
load();

// -----------------------------
// UI helpers
// -----------------------------
const $ = s => document.querySelector(s);
const moneyEl = $("#money");
const perMinEl = $("#perMin");
const invList = $("#invList");
const museumList = $("#museumList");
const curSiteEl = $("#curSite");
const curGameEl = $("#curGame");
const siteSummary = $("#siteSummary");
const digResults = $("#digResults");

function fmtMoney(v){ return "$" + Math.round(v).toLocaleString(); }

function refreshHUD() {
  moneyEl.textContent = fmtMoney(state.money);
  const perMin = state.museum.reduce((a,m)=>a+(m.perMin||0),0);
  perMinEl.textContent = fmtMoney(perMin);
  curSiteEl.textContent = state.currentSite ? state.currentSite.site : "None";
  curGameEl.textContent = state.game.gameId || "â€”";
  renderInventory();
  renderMuseum();
  renderSiteSummary();
  renderShop();
}

function renderInventory() {
  invList.innerHTML = "";
  if (!state.inventory.length) {
    invList.innerHTML = `<div class="muted small">Empty.</div>`;
    return;
  }
  state.inventory.forEach(item=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${item.name}</b> <span class="muted small">(${item.site})</span></div>
          <div class="small muted">Value: ${fmtMoney(item.price)} Â· Rarity: ${item.rarity}</div>
        </div>
        <div class="row">
          <button data-act="sell" data-id="${item.id}">Sell (${fmtMoney(item.price)})</button>
          ${MUSEUM_YIELD[item.name] ? `<button class="primary" data-act="museum" data-id="${item.id}">Display</button>` : `<span class="small muted">Not displayable</span>`}
        </div>
      </div>
    `;
    div.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.dataset.id;
      const ix = state.inventory.findIndex(x=>x.id===id);
      if (ix<0) return;
      const it = state.inventory[ix];
      if (btn.dataset.act==="sell") {
        state.money += it.price;
        state.inventory.splice(ix,1);
      } else if (btn.dataset.act==="museum") {
        state.inventory.splice(ix,1);
        state.museum.push({
          id: uid(),
          name: it.name,
          site: it.site,
          perMin: MUSEUM_YIELD[it.name] || 0
        });
      }
      save(); refreshHUD();
    });
    invList.appendChild(div);
  });
}

function renderMuseum() {
  museumList.innerHTML = "";
  if (!state.museum.length) {
    museumList.innerHTML = `<div class="muted small">No exhibits yet.</div>`;
    return;
  }
  state.museum.forEach(m=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${m.name}</b> <span class="muted small">(${m.site})</span></div>
          <div class="small muted">Income: ${fmtMoney(m.perMin)}/min</div>
        </div>
        <div>
          <button data-id="${m.id}">Remove</button>
        </div>
      </div>
    `;
    div.querySelector("button").addEventListener("click", ()=>{
      const ix = state.museum.findIndex(x=>x.id===m.id);
      if (ix>=0) state.museum.splice(ix,1);
      save(); refreshHUD();
    });
    museumList.appendChild(div);
  });
}

function renderSiteSummary() {
  if (!state.currentSite) { siteSummary.textContent = ""; return; }
  const pf = state.currentSite.possibleFinds || {};
  const entries = Object.entries(pf).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}: ${(v*100).toFixed(0)}%`);
  siteSummary.textContent = `Formation: ${state.currentSite.formation} Â· Odds: ${entries.join(" Â· ")}`;
}

// -----------------------------

// -----------------------------
// Permit system
// -----------------------------
function siteKeyFromObj(obj){
  // Prefer explicit tag_id + site; fall back to site or formation
  return obj.tag_id || obj.site || obj.formation || "unknown";
}

function isDLCFromObj(obj){
  // DLC if expansion flag present OR tag_id prefixed with DLC-
  return !!obj.expansion || (obj.tag_id && obj.tag_id.startsWith("DLC-"));
}

function formatPermitPrice(amount){
  return "$" + Math.round(amount).toLocaleString();
}

function nextBasePermitPrice(){
  return state.permitPriceBase;
}

function nextDLCPermitPrice(){
  return state.permitPriceBase * 2;
}

function bumpPermitPrice(){
  // After any purchase (base or DLC), base increases by 10%
  state.permitPriceBase = Math.round(state.permitPriceBase * 1.10);
}

function hasPermitFor(key){
  return !!state.permits[key];
}

/**
 * Ensures the user has a permit for this site.
 * If not, shows modal and returns a Promise<boolean> resolved with whether purchase happened.
 * Control tags (with t) should bypass and never come here.
 */
function ensurePermitForSite(siteObj){
  const key = siteKeyFromObj(siteObj);
  if (hasPermitFor(key)) return Promise.resolve(true);

  return new Promise((resolve)=>{
    const modal = document.getElementById("permitModal");
    const txt = document.getElementById("permitText");
    const btnBuy = document.getElementById("permitBuy");
    const btnCancel = document.getElementById("permitCancel");

    const isDLC = isDLCFromObj(siteObj);
    const price = isDLC ? nextDLCPermitPrice() : nextBasePermitPrice();
    txt.innerHTML = `You need a permit to excavate <b>${siteObj.site || siteObj.formation || "this area"}</b>.<br>` +
                    `Permit type: <b>${isDLC ? "DLC area" : "Base area"}</b><br>` +
                    `Cost: <b>${formatPermitPrice(price)}</b><br>` +
                    `<span class="muted small">Note: The price for the next permit increases by 10% after any purchase.</span>`;

    function close(res){
      modal.style.display = "none";
      btnBuy.onclick = null;
      btnCancel.onclick = null;
      resolve(res);
    }

    btnCancel.onclick = ()=> close(false);
    btnBuy.onclick = ()=>{
      if (state.money < price){
        alert("Not enough money for this permit.");
        return;
      }
      state.money -= price;
      state.permits[key] = {
        purchased_at: Date.now(),
        dlc: isDLC
      };
      bumpPermitPrice();
      save(); refreshHUD();
      close(true);
    };

    modal.style.display = "flex";
  });
}

// Shop logic
// -----------------------------
const SHOP_TOOLS = [
  { key: "brushes", name: "Brushes (Luck: rarer finds)", desc: "Increases odds of rarer items.", icon: "ðŸ–Œï¸" },
  { key: "jackhammers", name: "Jackhammers (Dig speed)", desc: "More items per hour.", icon: "â›ï¸" },
  { key: "shovels", name: "Shovels (Depth boost)", desc: "Better odds for deeper fossils.", icon: "ðŸª“" }
];
function tierCost(tier){ return 500 * Math.pow(2, tier); }
function renderShop(){
  const wrap = document.getElementById("shopList");
  if (!wrap) return;
  wrap.innerHTML = "";
  SHOP_TOOLS.forEach(t=>{
    const tier = state.tools?.[t.key] || 0;
    const next = tierCost(tier);
    const effectPct = (tier * 10);
    const row = document.createElement("div");
    row.className = "card";
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div><b>${t.icon} ${t.name}</b> <span class="muted small">Tier ${tier} Â· +${effectPct}%</span></div>
          <div class="small muted">${t.desc}</div>
        </div>
        <div class="row">
          <button data-key="${t.key}" ${state.money < next ? "disabled": ""}>Buy Tier ${tier+1} (${fmtMoney(next)})</button>
        </div>
      </div>
    `;
    row.querySelector("button").addEventListener("click", (e)=>{
      const key = e.target.getAttribute("data-key");
      const cur = state.tools[key] || 0;
      const cost = tierCost(cur);
      if (state.money < cost) { alert("Not enough money."); return; }
      state.money -= cost;
      state.tools[key] = cur + 1;
      save(); refreshHUD(); renderShop();
    });
    wrap.appendChild(row);
  });
}

// -----------------------------
// Museum income tick
// -----------------------------
setInterval(()=>{
  const now = Date.now();
  const mins = (now - state.lastIncomeTick)/60000;
  if (mins<=0) return;
  const perMin = state.museum.reduce((a,m)=>a+(m.perMin||0),0);
  const gain = perMin * mins;
  if (gain>0) {
    state.money += gain;
    state.lastIncomeTick = now;
    save(); refreshHUD();
  }
}, 2000);

// -----------------------------
const hoursInput = $("#digHours");
const hoursLabel = $("#hoursLabel");
hoursInput.addEventListener("input", ()=> hoursLabel.textContent = Number(hoursInput.value).toFixed(1));

function effectiveDraws(hours) {
  let draws = Math.max(1, Math.round(hours));
  const jackTier = (state.tools?.jackhammers)||0;
  const speedBoost = 0.10 * jackTier; // +10% per tier
  draws = Math.max(1, Math.round(draws * (1 + speedBoost)));
  return draws;
}

function adjustedWeights(baseTable){
  const brushTier = (state.tools?.brushes)||0;
  const luck = 0.10 * brushTier;

  const shovelTier = (state.tools?.shovels)||0;
  const depthBoost = 0.10 * shovelTier;

  let maxPrice = 0;
  for (const name in baseTable){
    const p = PRICE_TABLE[name] ?? 0;
    if (p > maxPrice) maxPrice = p;
  }
  if (maxPrice <= 0) maxPrice = 1;

  const entries = Object.entries(baseTable).map(([name, prob])=>{
    const price = PRICE_TABLE[name] ?? 0;
    const rarityFactor = 1 + (luck * (price / maxPrice));
    const depthScore = (price / maxPrice);
    const depthFactor = 1 + depthBoost * depthScore;
    const weight = prob * rarityFactor * depthFactor;
    return [name, weight];
  });

  const sum = entries.reduce((a,[,w])=>a+w,0) || 1;
  const norm = {};
  for (const [name, w] of entries) norm[name] = w / sum;
  return norm;
}

function weightedPickAdjusted(table){
  const entries = Object.entries(table);
  let r = Math.random();
  for (const [k,p] of entries) {
    r -= p;
    if (r <= 0) return k;
  }
  return entries[entries.length-1][0];
}

function rarityFromPrice(price) {
  if (price >= 8000) return "Legendary";
  if (price >= 4000) return "Rare";
  if (price >= 1500) return "Uncommon";
  if (price > 0)     return "Common";
  return "â€”";
}

document.getElementById("btn-dig").addEventListener("click", ()=>{
  if (!state.currentSite) { alert("Scan a site tag (or paste JSON) first."); return; }
  const hours = Number(hoursInput.value);
  const draws = effectiveDraws(hours);

  const results = [];
  const adjTable = adjustedWeights(state.currentSite.possibleFinds);
  for (let i=0;i<draws;i++) {
    const pick = weightedPickAdjusted(adjTable);
    if (pick==="NothingFound") {
      results.push({name:"NothingFound"});
      continue;
    }
    const price = PRICE_TABLE[pick] ?? 500;
    results.push({
      id: uid(),
      name: pick,
      site: state.currentSite.site,
      rarity: rarityFromPrice(price),
      price
    });
  }

  const digResults = document.getElementById("digResults");
  digResults.innerHTML = "";
  if (!results.some(r=>r.name!=="NothingFound")) {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<div class="bad">You found nothing this time. Try more hours or a different site.</div>`;
    digResults.appendChild(div);
  } else {
    results.forEach(r=>{
      if (r.name==="NothingFound") return;
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="found"><b>${r.name}</b> <span class="muted small">(${r.site})</span></div>
            <div class="small muted">Rarity: ${r.rarity} Â· Value: ${fmtMoney(r.price)}</div>
          </div>
          <div class="row">
            <button data-act="sell">Sell (${fmtMoney(r.price)})</button>
            ${MUSEUM_YIELD[r.name] ? `<button class="primary" data-act="museum">Display</button>` : `<span class="small muted">Not displayable</span>`}
            <button data-act="keep">Keep</button>
          </div>
        </div>
      `;
      div.addEventListener("click",(e)=>{
        const b = e.target.closest("button");
        if (!b) return;
        div.querySelectorAll("button").forEach(btn => btn.disabled = true);

        if (b.dataset.act==="sell") {
          state.money += r.price;
        } else if (b.dataset.act==="museum") {
          state.museum.push({ id: uid(), name: r.name, site: r.site, perMin: MUSEUM_YIELD[r.name]||0 });
        } else if (b.dataset.act==="keep") {
          state.inventory.push({ id: r.id, name: r.name, site: r.site, rarity: r.rarity, price: r.price });
        }

        save(); refreshHUD();
        div.remove();
      });
      digResults.appendChild(div);
    });
    save(); refreshHUD();
  }
});

// -----------------------------
// Web NFC support badge
// -----------------------------
function setSupportBadge(){
  const sup = document.getElementById("support");
  if (!('NDEFReader' in window)) {
    sup.textContent = "Web NFC not available (Chrome on Android, HTTPS/localhost required)";
    sup.classList.add("warn");
  } else {
    sup.textContent = window.isSecureContext ? "Web NFC ready (secure context)" : "Serve over HTTPS or http://localhost";
    if (!window.isSecureContext) sup.classList.add("warn");
  }
}
setSupportBadge();

// -----------------------------
// Load site JSON helper & manual
// -----------------------------
async function loadSiteFromJSONText(text) {
  try {
    const obj = JSON.parse(text);
    if (!obj.site && !obj.t) throw new Error("Missing fields");
    if (obj.t) { await routeControlTag(obj, text); return; }
    if (!obj.possibleFinds) throw new Error("No possibleFinds in site JSON");
    state.currentSite = obj;
    save(); refreshHUD();
    alert("Loaded site: " + (state.currentSite?.site || "unknown"));
  } catch (e) {
    alert("Invalid JSON\\n" + e);
  }
}
document.getElementById("btn-load-json").addEventListener("click", ()=>{
  const txt = document.getElementById("manualJson").value.trim();
  if (!txt) return alert("Paste JSON first.");
  loadSiteFromJSONText(txt);
});

// -----------------------------
// NFC read helpers
// -----------------------------
async function ndefReadOnce(){
  const ndef = new NDEFReader();
  await ndef.scan();
  return new Promise((resolve, reject)=>{
    ndef.onreading = ev => {
      for (const rec of ev.message.records) {
        try {
          const txt = new TextDecoder(rec.encoding || "utf-8").decode(rec.data);
          return resolve(txt);
        } catch {}
      }
      reject(new Error("No text payload"));
    };
    ndef.onreadingerror = () => reject(new Error("Read error"));
  });
}
async function ndefWriteText(text){
  const ndef = new NDEFReader();
  await ndef.write(text);
}

// -----------------------------
// Control tags: seed/join/results
// -----------------------------
function handleGameSeed(obj){
  state.game.gameId = obj.game_id || null;
  state.game.rules = obj;
  save(); refreshHUD();
  alert("Game seed loaded.\\nGame ID: " + state.game.gameId);
}

async function handleGameJoin(rawText){
  const obj = JSON.parse(rawText);
  if (obj.t !== "game_join") throw new Error("Not a join tag");
  if (state.game.gameId && obj.game_id && obj.game_id !== state.game.gameId){
    if (!confirm("Join tag Game ID differs. Continue?")) return;
  }
  obj.game_id ||= state.game.gameId;
  obj.players ||= [];
  if (!obj.players.some(p=>p?.device_hash===state.game.deviceHash)){
    obj.players.push({
      player_id: state.game.playerId,
      name_hint: null,
      device_hash: state.game.deviceHash,
      starter_site_id: state.currentSite?.site || null,
      joined_at: Math.floor(Date.now()/1000)
    });
  }
  await ndefWriteText(JSON.stringify(obj));
  alert("Joined game: " + (obj.game_id||"(no id)"));
}

function buildSubmission(){
  const money = Math.round(state.money);
  const museumPerMin = state.museum.reduce((a,m)=>a+(m.perMin||0),0);
  const findsSold = 0;
  const findsDisplayed = state.museum.length;
  const raresFound = state.inventory.filter(i=>i.rarity==="Rare"||i.rarity==="Legendary").length;
  const siteScans = 0;
  const turnsUsed = 0;
  return {
    player_id: state.game.playerId,
    device_hash: state.game.deviceHash,
    money, museum_per_min: museumPerMin,
    finds_sold: findsSold, finds_displayed: findsDisplayed,
    rares_found: raresFound, site_scans: siteScans, turns_used: turnsUsed
  };
}

function finalizeResultsFromSubmissions(submissions, metric="money"){
  const placements = [...submissions]
    .sort((a,b)=>(b[metric]||0)-(a[metric]||0))
    .map((s, i)=>({rank:i+1, player_id:s.player_id, [metric]:s[metric]}));
  return {
    ranking_metric: metric,
    placements,
    finalized_at: Math.floor(Date.now()/1000)
  };
}

async function handleGameResults(rawText, mode="auto"){
  const obj = JSON.parse(rawText);
  if (obj.t !== "game_results") throw new Error("Not a results tag");
  if (state.game.gameId && obj.game_id && obj.game_id !== state.game.gameId){
    if (!confirm("Results tag Game ID differs. Continue?")) return;
  }
  obj.submissions ||= [];

  if (obj.phase === "collect"){
    if (!obj.submissions.some(s=>s?.device_hash===state.game.deviceHash)){
      obj.submissions.push(buildSubmission());
      await ndefWriteText(JSON.stringify(obj));
      alert("Submitted your stats. When all players submit, host finalizes.");
    } else {
      alert("You already submitted.");
    }

    if (mode === "finalize"){
      obj.results = finalizeResultsFromSubmissions(obj.submissions, "money");
      obj.phase = "finalized";
      await ndefWriteText(JSON.stringify(obj));
      alert("Results finalized. Everyone can scan again to see placements.");
    }

  } else if (obj.phase === "finalized"){
    const me = obj.submissions.find(s=>s?.device_hash===state.game.deviceHash);
    const top = obj.results?.placements?.[0];
    alert(
      "Winner: " + (top?.player_id||"unknown") + "\\n" +
      "Your money: " + (me?.money ?? "?")
    );
  } else {
    alert("Unknown results phase.");
  }
}

async function routeControlTag(obj, rawText){
  if (obj.t === "game_seed") return handleGameSeed(obj);
  if (obj.t === "game_join") return handleGameJoin(rawText);
  if (obj.t === "game_results") return handleGameResults(rawText /*, "finalize"*/);
  const ok = await ensurePermitForSite(obj);
  if (!ok) return; 
  state.currentSite = obj;
  save(); refreshHUD();
}

// -----------------------------
// Scan button (routes by tag type)
// -----------------------------
document.getElementById("btn-scan").addEventListener("click", async ()=>{
  if (!('NDEFReader' in window)) { alert("Web NFC not supported in this browser."); return; }
  if (!window.isSecureContext) { alert("Open over HTTPS or http://localhost for Web NFC."); return; }
  try {
    const text = await ndefReadOnce();
    try {
      const obj = JSON.parse(text);
      await routeControlTag(obj, text);
      if (!obj.t && obj.site) alert("Loaded site: " + (obj.site || "unknown"));
    } catch {
      alert("Tag text wasnâ€™t valid JSON.");
    }
  } catch (err) {
    alert("Scan failed: " + err);
  }
});

// Initial paint
refreshHUD();
</script>
</body>
</html>
